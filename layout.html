<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Interactive Layout: Auth Secured</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡∏´‡∏ô‡πà‡∏ß‡∏¢ cm (20cm = 15cm Main + 5cm Extra) */
        .paper-size { width: 20cm; height: 30cm; }
        
        .no-select { user-select: none; -webkit-user-select: none; }

        /* ‡∏•‡∏≤‡∏¢‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏© */
        .paper-bg {
            background-color: white;
            background-image: linear-gradient(#e5e7eb 1px, transparent 1px),
            linear-gradient(90deg, #e5e7eb 1px, transparent 1px);
            background-size: 1cm 1cm;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transform-origin: top left; 
        }

        /* Styles ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏ */
        .draggable-item {
            transition: box-shadow 0.2s;
            cursor: move; 
        }
        
        /* Read-only mode for items */
        .read-only-mode .draggable-item {
            cursor: default !important; /* ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Cursor ‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥ */
        }
        /* ‡∏ã‡πà‡∏≠‡∏ô Handle ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡πá‡∏≠‡∏Ñ‡∏≠‡∏¥‡∏ô */
        .read-only-mode .resize-handle,
        .read-only-mode .rotate-handle,
        .read-only-mode .controls {
            display: none !important;
        }

        .item-content {
            width: 100%;
            height: 100%;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 2px;
            pointer-events: none; 
        }

        .draggable-item.active-item {
            z-index: 100 !important;
            box-shadow: 0 0 0 2px #3b82f6; 
        }

        /* Controls Visibility */
        .draggable-item .controls { opacity: 0; pointer-events: none; transition: opacity 0.2s; }
        .draggable-item.active-item .controls { opacity: 1; pointer-events: auto; }
        
        /* Resize Handle */
        .resize-handle {
            width: 12px;
            height: 12px;
            background-color: #3b82f6;
            border: 2px solid white;
            border-radius: 50%;
            position: absolute;
            bottom: -6px;
            right: -6px;
            cursor: nwse-resize;
            z-index: 60;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        /* Rotate Handle */
        .rotate-handle {
            opacity: 0; transition: opacity 0.2s;
        }
        .draggable-item.active-item .rotate-handle,
        .draggable-item:hover .rotate-handle { opacity: 1; }

        @media (hover: none) {
            .rotate-handle { opacity: 1; } 
        }

        /* Text Object Style */
        .type-text .item-content {
            background: rgba(255, 255, 200, 0.3); 
            border: 1px dashed #cbd5e1;
            align-items: flex-start; 
            padding: 4px;
            justify-content: flex-start; 
        }
        .type-text .box-text {
            writing-mode: horizontal-tb !important; 
            transform: none !important;
            text-align: left;
            white-space: normal; 
            font-size: 14px; 
            line-height: 1.2;
            color: #1e293b;
            width: 100%;
        }

        /* Loading Overlay */
        #loader {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(4px);
        }

        .modal-overlay { background-color: rgba(0, 0, 0, 0.5); }

        #workspace { cursor: grab; }
        #workspace:active { cursor: grabbing; }
        #workspace::-webkit-scrollbar { width: 8px; height: 8px; }
        #workspace::-webkit-scrollbar-track { background: #f1f5f9; }
        #workspace::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        
        .tiny-object .box-text { display: none !important; }
    </style>
</head>
<body class="bg-slate-800 h-screen w-full overflow-hidden flex flex-col font-sans">

    <!-- Header -->
    <div class="bg-white p-2 shadow-sm z-20 flex justify-between items-center shrink-0 border-b relative h-14">
        <div class="flex items-center gap-2 sm:gap-4">
            <div>
                <h1 class="text-sm sm:text-lg font-bold text-slate-800">Layout Manager</h1>
                <p id="user-status" class="text-[10px] text-slate-500 hidden sm:block">Guest Mode (View Only)</p>
            </div>
            
            <!-- Auth & Actions Area -->
            <div class="flex gap-2 items-center">
                
                <!-- Editor Buttons (Hidden by default) -->
                <div id="editor-tools" class="hidden flex gap-2">
                    <button onclick="openAddModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded shadow text-xs sm:text-sm flex items-center gap-1 font-bold">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                        ‡πÄ‡∏û‡∏¥‡πà‡∏°
                    </button>

                    <button onclick="savePositions()" id="save-btn" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1.5 rounded shadow text-xs sm:text-sm flex items-center gap-1 font-bold">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                        <span id="save-text">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</span>
                    </button>
                </div>

                <!-- Auth Buttons -->
                <button id="btn-login" onclick="openLoginModal()" class="bg-slate-700 hover:bg-slate-800 text-white px-3 py-1.5 rounded text-xs font-bold">
                    ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
                </button>
                <button id="btn-logout" onclick="handleLogout()" class="hidden border border-red-200 text-red-600 hover:bg-red-50 px-3 py-1.5 rounded text-xs font-bold">
                    ‡∏≠‡∏≠‡∏Å
                </button>
            </div>
        </div>
    </div>

    <!-- Workspace -->
    <!-- Add 'read-only-mode' class by default, removed by JS if logged in -->
    <div class="flex-1 overflow-auto bg-slate-200 relative w-full h-full flex read-only-mode" id="workspace">
        
        <div id="paper-wrapper" class="relative m-auto transition-all duration-200 ease-out box-content p-10">
            <div id="paper" class="paper-size paper-bg relative bg-white border border-slate-300 shadow-xl"> 
                
                <!-- Separator -->
                <div class="absolute top-0 bottom-0 border-l-2 border-dashed border-slate-300 z-0 flex flex-col justify-between py-2 pointer-events-none" style="left: 15cm;">
                     <span class="text-[10px] text-slate-400 -ml-8 bg-white/50 px-1">Zone A</span>
                     <span class="text-[10px] text-slate-400 pl-1 bg-white/50 px-1">Zone B</span>
                </div>
                
                <!-- Layout Area Hint -->
                <div class="absolute border-2 border-black pointer-events-none z-0" 
                     style="width: 12cm; height: 24cm; left: 7.5cm; transform: translateX(-50%); top: 1.5cm;">
                     <span class="absolute -top-6 left-0 text-xs text-slate-400 whitespace-nowrap">Layout (12x24cm)</span>
                </div>

                <!-- Items -->
            </div>
        </div>

        <!-- Zoom Controls -->
        <div class="fixed bottom-4 left-4 z-40 flex flex-col gap-2 bg-white/90 p-2 rounded-lg shadow-lg backdrop-blur-sm border border-slate-200">
            <button onclick="adjustZoom(0.1)" class="p-2 hover:bg-slate-100 rounded text-slate-700" title="Zoom In">+</button>
            <div id="zoom-level-text" class="text-[10px] text-center font-mono text-slate-500">100%</div>
            <button onclick="adjustZoom(-0.1)" class="p-2 hover:bg-slate-100 rounded text-slate-700" title="Zoom Out">-</button>
            <button onclick="resetZoom()" class="p-2 hover:bg-slate-100 rounded text-slate-700 border-t mt-1" title="Fit">Fit</button>
        </div>

        <!-- Floating Action Panel (Context Menu) - Hidden if read-only -->
        <div id="action-panel" class="absolute bottom-6 right-6 translate-y-32 transition-transform duration-300 z-50 fixed flex flex-col gap-2 items-end">
            
            <div class="flex gap-2 bg-white p-2 rounded-lg shadow-xl border border-slate-200">
                 <button onclick="editActiveText()" id="btn-edit-text" class="hidden bg-slate-100 hover:bg-slate-200 text-slate-700 px-3 py-2 rounded flex items-center gap-1 text-sm font-bold">
                    ‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
                </button>
                <button onclick="duplicateActiveItem()" class="bg-blue-100 hover:bg-blue-200 text-blue-700 px-3 py-2 rounded flex items-center gap-1 text-sm font-bold">
                    ‚ùê ‡∏ó‡∏≥‡∏ã‡πâ‡∏≥
                </button>
                <button onclick="deleteActiveItem()" class="bg-red-100 hover:bg-red-200 text-red-600 px-3 py-2 rounded flex items-center gap-1 text-sm font-bold">
                    üóëÔ∏è ‡∏•‡∏ö
                </button>
            </div>
        </div>

        <!-- Loader -->
        <div id="loader" class="absolute inset-0 z-50 flex items-center justify-center flex-col fixed">
            <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-slate-800 mb-3"></div>
            <span class="text-slate-600 font-medium text-sm">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="login-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 modal-overlay" onclick="closeLoginModal()"></div>
        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white rounded-lg p-6 shadow-xl w-80">
            <h2 class="text-lg font-bold mb-4 text-slate-800 text-center">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h2>
            <div class="space-y-3">
                <input type="email" id="login-email" class="w-full border rounded p-2 text-sm" placeholder="Email">
                <input type="password" id="login-password" class="w-full border rounded p-2 text-sm" placeholder="Password">
            </div>
            <button onclick="handleLogin()" class="w-full mt-4 bg-slate-800 text-white py-2 rounded font-bold hover:bg-slate-900">
                Login
            </button>
            <p id="login-error" class="text-red-500 text-xs mt-2 text-center hidden"></p>
        </div>
    </div>

    <!-- Add Object Modal -->
    <div id="add-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 modal-overlay" onclick="closeAddModal()"></div>
        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white rounded-lg p-6 shadow-xl w-80">
            <h2 class="text-lg font-bold mb-4 text-slate-800">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà</h2>
            
            <!-- Tabs -->
            <div class="flex border-b mb-4">
                <button class="flex-1 py-2 text-sm font-bold border-b-2 border-blue-600 text-blue-600" id="tab-obj" onclick="switchTab('obj')">‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏ (‡∏£‡∏ñ)</button>
                <button class="flex-1 py-2 text-sm font-bold text-slate-500" id="tab-text" onclick="switchTab('text')">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</button>
            </div>

            <!-- Form Content -->
            <div id="form-content">
                <div class="space-y-3">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1" id="lbl-name">‡∏ä‡∏∑‡πà‡∏≠/‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</label>
                        <input type="text" id="input-label" class="w-full border rounded p-2 text-sm" placeholder="‡∏£‡∏∞‡∏ö‡∏∏...">
                    </div>
                    
                    <div id="dim-inputs" class="flex gap-3">
                        <div class="w-1/2">
                            <label class="block text-xs font-bold text-slate-500 mb-1">‡∏Å‡∏ß‡πâ‡∏≤‡∏á (cm)</label>
                            <input type="number" id="input-w" step="0.1" class="w-full border rounded p-2 text-sm" value="2">
                        </div>
                        <div class="w-1/2">
                            <label class="block text-xs font-bold text-slate-500 mb-1">‡∏™‡∏π‡∏á (cm)</label>
                            <input type="number" id="input-h" step="0.1" class="w-full border rounded p-2 text-sm" value="5.7">
                        </div>
                    </div>
                    
                    <div id="type-select-wrapper">
                        <label class="block text-xs font-bold text-slate-500 mb-1">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label>
                        <select id="input-type" class="w-full border rounded p-2 text-sm">
                            <option value="pickup">‡∏£‡∏ñ‡∏Å‡∏£‡∏∞‡∏ö‡∏∞ (‡πÄ‡∏ó‡∏≤)</option>
                            <option value="mux">MU-X (‡∏ü‡πâ‡∏≤)</option>
                            <option value="frr">FRR (‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á)</option>
                            <option value="custom">‡∏≠‡∏∑‡πà‡∏ô ‡πÜ (‡∏Ç‡∏≤‡∏ß)</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="mt-6 flex justify-end gap-2">
                <button onclick="closeAddModal()" class="px-4 py-2 text-sm text-slate-600 hover:bg-slate-100 rounded">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button onclick="confirmAddItem()" class="px-4 py-2 text-sm bg-blue-600 text-white hover:bg-blue-700 rounded font-bold">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIG ---
        const SUPABASE_URL = 'https://dcigpisivgpofeljvoph.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_ccUnFtL3x-8eV8exjy4oIw__JiDK4VK'; 
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const paper = document.getElementById('paper');
        const paperWrapper = document.getElementById('paper-wrapper');
        const workspace = document.getElementById('workspace');
        const loader = document.getElementById('loader');
        const actionPanel = document.getElementById('action-panel');
        const zoomText = document.getElementById('zoom-level-text');

        // UI Elements for Auth
        const editorTools = document.getElementById('editor-tools');
        const btnLogin = document.getElementById('btn-login');
        const btnLogout = document.getElementById('btn-logout');
        const userStatus = document.getElementById('user-status');
        const loginModal = document.getElementById('login-modal');
        const loginError = document.getElementById('login-error');

        const CM_TO_PX = 37.8; // Approx 96dpi

        const typeColors = {
            'pickup': { bg: 'bg-gray-400', txt: 'text-white' },
            'mux':    { bg: 'bg-sky-300',  txt: 'text-slate-800' },
            'frr':    { bg: 'bg-amber-300', txt: 'text-slate-900' },
            'custom': { bg: 'bg-slate-100', txt: 'text-slate-900' },
            'text':   { bg: '', txt: '' } 
        };

        // State
        let baseScale = 1;      
        let userZoom = 1.0;     
        let totalScale = 1;     
        let activeItem = null;
        let addMode = 'obj'; 
        let currentUser = null; // User Session

        // --- AUTH LOGIC ---

        function updateAuthUI(session) {
            currentUser = session?.user || null;

            if (currentUser) {
                // Logged In
                workspace.classList.remove('read-only-mode');
                editorTools.classList.remove('hidden');
                btnLogin.classList.add('hidden');
                btnLogout.classList.remove('hidden');
                userStatus.innerText = `User: ${currentUser.email}`;
                userStatus.className = 'text-[10px] text-green-600 font-bold hidden sm:block';
            } else {
                // Guest
                workspace.classList.add('read-only-mode');
                editorTools.classList.add('hidden');
                btnLogin.classList.remove('hidden');
                btnLogout.classList.add('hidden');
                userStatus.innerText = 'Guest Mode (View Only)';
                userStatus.className = 'text-[10px] text-slate-500 hidden sm:block';
                deselectAll(); // Clear selection if any
            }
        }

        async function handleLogin() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            loginError.classList.add('hidden');
            
            const { data, error } = await supabaseClient.auth.signInWithPassword({
                email,
                password
            });

            if (error) {
                loginError.innerText = error.message;
                loginError.classList.remove('hidden');
            } else {
                closeLoginModal();
                // onAuthStateChange will handle UI update
            }
        }

        async function handleLogout() {
            await supabaseClient.auth.signOut();
        }

        function openLoginModal() { 
            loginModal.classList.remove('hidden'); 
            document.getElementById('login-email').focus();
        }
        function closeLoginModal() { loginModal.classList.add('hidden'); }


        // --- CORE: INIT & DB ---
        async function initApp() {
            // Check Auth Initial Session
            const { data: { session } } = await supabaseClient.auth.getSession();
            updateAuthUI(session);

            // Listen for Auth Changes
            supabaseClient.auth.onAuthStateChange((_event, session) => {
                updateAuthUI(session);
            });

            calculateBaseScale(); 
            await fetchItems();
            loader.classList.add('hidden');
        }

        async function fetchItems() {
            const { data, error } = await supabaseClient
                .from('canvas_items')
                .select('*')
                .eq('is_deleted', false)
                .order('id', { ascending: true });

            if (error) {
                console.error(error);
                // Don't alert for Guests might be annoying, just log
                return;
            }

            document.querySelectorAll('.draggable-item').forEach(el => el.remove());
            if (data) data.forEach(item => renderItem(item));
        }

        async function savePositions() {
            if (!currentUser) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å');

            const btn = document.getElementById('save-btn');
            const txt = document.getElementById('save-text');
            const originalText = txt.innerText;
            
            btn.classList.add('opacity-75', 'cursor-not-allowed');
            txt.innerText = '...';
            
            const items = document.querySelectorAll('.draggable-item');
            const updates = Array.from(items).map(el => {
                return {
                    id: parseInt(el.dataset.dbId),
                    label: el.dataset.label,
                    type: el.dataset.type,
                    w: parseFloat(el.dataset.w),
                    h: parseFloat(el.dataset.h),
                    x: parseFloat(el.style.left),
                    y: parseFloat(el.style.top),
                    rotation: parseFloat(el.dataset.rotation),
                    updated_at: new Date()
                };
            });

            try {
                const { error } = await supabaseClient.from('canvas_items').upsert(updates);
                if (error) throw error;
                txt.innerText = 'OK';
            } catch (err) {
                console.error(err);
                alert('Save Error: ' + err.message);
            } finally {
                setTimeout(() => {
                    txt.innerText = originalText;
                    btn.classList.remove('opacity-75', 'cursor-not-allowed');
                }, 1000);
            }
        }

        // --- ITEM ACTIONS ---

        async function confirmAddItem() {
            if (!currentUser) return;

            const label = document.getElementById('input-label').value.trim() || (addMode === 'text' ? '‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°' : 'Object');
            let w = parseFloat(document.getElementById('input-w').value) || 2;
            let h = parseFloat(document.getElementById('input-h').value) || 2;
            let type = addMode === 'text' ? 'text' : document.getElementById('input-type').value;

            closeAddModal();
            loader.classList.remove('hidden');

            try {
                const { data, error } = await supabaseClient
                    .from('canvas_items')
                    .insert([{
                        label: label,
                        type: type,
                        w: w, h: h,
                        x: 50, y: 50,
                        rotation: 0
                    }])
                    .select().single();

                if (error) throw error;
                renderItem(data);
            } catch (err) {
                alert('Add Error: ' + err.message);
            } finally {
                loader.classList.add('hidden');
            }
        }

        async function deleteActiveItem() {
            if (!currentUser || !activeItem) return;
            const id = parseInt(activeItem.dataset.dbId);
            if (!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö?')) return;

            try {
                const { error } = await supabaseClient
                    .from('canvas_items')
                    .update({ is_deleted: true })
                    .eq('id', id);
                
                if (error) throw error;
                activeItem.remove();
                deselectAll();
            } catch (err) {
                alert('Delete Error: ' + err.message);
            }
        }

        async function duplicateActiveItem() {
            if (!currentUser || !activeItem) return;
            
            const props = {
                label: activeItem.dataset.label,
                type: activeItem.dataset.type,
                w: parseFloat(activeItem.dataset.w),
                h: parseFloat(activeItem.dataset.h),
                x: parseFloat(activeItem.style.left) + 20, 
                y: parseFloat(activeItem.style.top) + 20,
                rotation: parseFloat(activeItem.dataset.rotation)
            };

            loader.classList.remove('hidden');
            try {
                const { data, error } = await supabaseClient
                    .from('canvas_items')
                    .insert([props])
                    .select().single();
                
                if (error) throw error;
                renderItem(data);
            } catch (err) {
                alert('Copy Error: ' + err.message);
            } finally {
                loader.classList.add('hidden');
            }
        }

        async function editActiveText() {
            if (!currentUser || !activeItem || activeItem.dataset.type !== 'text') return;
            const newText = prompt("‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°:", activeItem.dataset.label);
            if (newText !== null) {
                activeItem.dataset.label = newText;
                activeItem.querySelector('.box-text').innerText = newText;
            }
        }

        // --- RENDERING ---

        function renderItem(obj) {
            const el = document.createElement('div');
            el.className = `draggable-item absolute group select-none touch-none type-${obj.type}`;
            
            // Apply Properties
            el.style.width = `${obj.w}cm`;
            el.style.height = `${obj.h}cm`;
            el.style.left = `${obj.x}px`;
            el.style.top = `${obj.y}px`;
            el.style.transform = `rotate(${obj.rotation}deg)`;
            
            // Dataset
            el.dataset.dbId = obj.id;
            el.dataset.label = obj.label || '';
            el.dataset.type = obj.type;
            el.dataset.w = obj.w;
            el.dataset.h = obj.h;
            el.dataset.rotation = obj.rotation;

            checkTextVisibility(el, obj.w, obj.h);

            const style = typeColors[obj.type] || typeColors['custom'];
            const contentClass = `item-content ${style.bg} ${obj.type === 'text' ? '' : 'shadow-sm border border-black/20 hover:border-black/50'} transition-colors`;
            const textClass = `box-text font-bold ${style.txt} text-center leading-tight block whitespace-nowrap`;
            
            const textStyle = obj.type === 'text' ? '' : 'writing-mode: vertical-rl; text-orientation: mixed; transform: rotate(180deg);';

            el.innerHTML = `
                <div class="controls">
                    <div class="rotate-handle w-8 h-8 absolute -top-10 left-1/2 -translate-x-1/2 flex items-center justify-center cursor-alias z-50">
                        <div class="w-3 h-3 bg-white rounded-full border-2 border-blue-500 shadow"></div>
                        <div class="w-[1px] h-4 bg-blue-300 absolute -bottom-4"></div>
                    </div>
                    <div class="resize-handle" data-action="resize"></div>
                </div>
                <div class="${contentClass}">
                    <span class="${textClass}" style="${textStyle}">
                        ${obj.label}
                    </span>
                </div>
            `;

            el.addEventListener('mousedown', handleMouseDown);
            el.addEventListener('touchstart', handleMouseDown, { passive: false });
            el.addEventListener('click', (e) => selectItem(e, el));

            paper.appendChild(el);
        }

        function checkTextVisibility(el, w, h) {
            if (w < 1.5 || h < 1.0) {
                el.classList.add('tiny-object');
            } else {
                el.classList.remove('tiny-object');
            }
        }

        // --- INTERACTION LOGIC ---

        let interactionMode = null; 
        let startX, startY, startLeft, startTop, startW, startH, startRot, startAngle;

        // Panning Variables
        let isPanning = false;
        let panStartX, panStartY, scrollStartX, scrollStartY;

        // Workspace Pan (Available for Everyone)
        workspace.addEventListener('mousedown', (e) => {
            if (e.target.closest('.draggable-item') || e.target.closest('button') || e.target.closest('.modal-overlay') || e.target.closest('input')) return;
            isPanning = true;
            panStartX = e.clientX; panStartY = e.clientY;
            scrollStartX = workspace.scrollLeft; scrollStartY = workspace.scrollTop;
            workspace.style.cursor = 'grabbing';
            document.addEventListener('mousemove', onPanMove);
            document.addEventListener('mouseup', onPanUp);
        });

        function onPanMove(e) {
            if (!isPanning) return;
            const dx = e.clientX - panStartX;
            const dy = e.clientY - panStartY;
            workspace.scrollLeft = scrollStartX - dx;
            workspace.scrollTop = scrollStartY - dy;
        }

        function onPanUp() {
            isPanning = false;
            workspace.style.cursor = 'grab';
            document.removeEventListener('mousemove', onPanMove);
            document.removeEventListener('mouseup', onPanUp);
        }

        // Item Interaction
        function handleMouseDown(e) {
            const item = e.target.closest('.draggable-item');
            if (!item) return;
            
            // Allow selection for everyone (to see labels), but check permissions for actions
            selectItem(e, item);

            // AUTH CHECK: If not logged in, stop here (allow select, deny modify)
            if (!currentUser) return;

            if (e.target.closest('.resize-handle')) {
                interactionMode = 'resize';
            } else if (e.target.closest('.rotate-handle')) {
                interactionMode = 'rotate';
            } else {
                interactionMode = 'drag';
            }

            e.stopPropagation();
            e.preventDefault(); 

            const clientX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
            const clientY = e.type.includes('mouse') ? e.clientY : e.touches[0].clientY;
            startX = clientX;
            startY = clientY;

            if (interactionMode === 'drag') {
                startLeft = parseFloat(item.style.left);
                startTop = parseFloat(item.style.top);
            } else if (interactionMode === 'resize') {
                startW = parseFloat(item.dataset.w); 
                startH = parseFloat(item.dataset.h);
            } else if (interactionMode === 'rotate') {
                const rect = item.getBoundingClientRect();
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;
                startRot = parseFloat(item.dataset.rotation);
                startAngle = Math.atan2(clientY - centerY, clientX - centerX);
            }

            document.addEventListener('mousemove', onMove);
            document.addEventListener('touchmove', onMove, { passive: false });
            document.addEventListener('mouseup', onEnd);
            document.addEventListener('touchend', onEnd);
        }

        function onMove(e) {
            if (!activeItem || !interactionMode) return;
            e.preventDefault();

            const clientX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
            const clientY = e.type.includes('mouse') ? e.clientY : e.touches[0].clientY;

            if (interactionMode === 'drag') {
                const dx = (clientX - startX) / totalScale;
                const dy = (clientY - startY) / totalScale;
                activeItem.style.left = `${startLeft + dx}px`;
                activeItem.style.top = `${startTop + dy}px`;

            } else if (interactionMode === 'resize') {
                const dxPx = (clientX - startX) / totalScale;
                const dyPx = (clientY - startY) / totalScale;
                
                const dW = dxPx / CM_TO_PX;
                const dH = dyPx / CM_TO_PX;
                
                let newW = Math.max(0.5, startW + dW);
                let newH = Math.max(0.5, startH + dH);
                
                activeItem.style.width = `${newW}cm`;
                activeItem.style.height = `${newH}cm`;
                activeItem.dataset.w = newW;
                activeItem.dataset.h = newH;
                
                checkTextVisibility(activeItem, newW, newH);

            } else if (interactionMode === 'rotate') {
                const rect = activeItem.getBoundingClientRect();
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;
                const curAngle = Math.atan2(clientY - centerY, clientX - centerX);
                const deltaDeg = (curAngle - startAngle) * (180 / Math.PI);
                const newRot = startRot + deltaDeg;
                
                activeItem.style.transform = `rotate(${newRot}deg)`;
                activeItem.dataset.rotation = newRot;
            }
        }

        function onEnd() {
            interactionMode = null;
            document.removeEventListener('mousemove', onMove);
            document.removeEventListener('touchmove', onMove);
            document.removeEventListener('mouseup', onEnd);
            document.removeEventListener('touchend', onEnd);
        }

        function selectItem(e, el) {
            e.stopPropagation(); 
            if (activeItem && activeItem !== el) {
                activeItem.classList.remove('active-item');
            }
            activeItem = el;
            activeItem.classList.add('active-item');
            
            // UI Logic: Show tools ONLY if logged in
            if (currentUser) {
                const btnEdit = document.getElementById('btn-edit-text');
                if (el.dataset.type === 'text') {
                    btnEdit.classList.remove('hidden');
                } else {
                    btnEdit.classList.add('hidden');
                }
                actionPanel.classList.remove('translate-y-32');
            }
        }

        function deselectAll() {
            if (activeItem) {
                activeItem.classList.remove('active-item');
                activeItem = null;
            }
            actionPanel.classList.add('translate-y-32');
        }

        // --- UI ---
        function switchTab(mode) {
            addMode = mode;
            document.getElementById('tab-obj').className = mode === 'obj' ? 'flex-1 py-2 text-sm font-bold border-b-2 border-blue-600 text-blue-600' : 'flex-1 py-2 text-sm font-bold text-slate-500';
            document.getElementById('tab-text').className = mode === 'text' ? 'flex-1 py-2 text-sm font-bold border-b-2 border-blue-600 text-blue-600' : 'flex-1 py-2 text-sm font-bold text-slate-500';
            
            if (mode === 'text') {
                document.getElementById('lbl-name').innerText = '‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°';
                document.getElementById('type-select-wrapper').classList.add('hidden');
                document.getElementById('input-w').value = 4;
                document.getElementById('input-h').value = 1.5;
            } else {
                document.getElementById('lbl-name').innerText = '‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏';
                document.getElementById('type-select-wrapper').classList.remove('hidden');
                document.getElementById('input-w').value = 2;
                document.getElementById('input-h').value = 5.7;
            }
        }

        function openAddModal() { 
            if(!currentUser) return;
            document.getElementById('add-modal').classList.remove('hidden');
            switchTab('obj'); 
        }
        function closeAddModal() { document.getElementById('add-modal').classList.add('hidden'); }

        // --- SCALE ---
        function calculateBaseScale() {
            const margin = 40;
            const availableWidth = workspace.clientWidth - (margin * 2);
            const availableHeight = workspace.clientHeight - (margin * 2);
            paper.style.transform = 'none';
            const paperWidth = paper.offsetWidth; 
            const paperHeight = paper.offsetHeight;
            
            const scaleX = availableWidth / paperWidth;
            const scaleY = availableHeight / paperHeight;
            baseScale = Math.min(scaleX, scaleY, 1.0);
            updateTransform();
        }

        function updateTransform() {
            totalScale = baseScale * userZoom;
            paper.style.transform = `scale(${totalScale})`;
            paperWrapper.style.width = `${20 * 37.8 * totalScale}px`; 
            paperWrapper.style.height = `${30 * 37.8 * totalScale}px`; 
            zoomText.innerText = `${Math.round(userZoom * 100)}%`;
        }

        function adjustZoom(delta) { userZoom = Math.min(5, Math.max(0.2, userZoom + delta)); updateTransform(); }
        function resetZoom() { userZoom = 1.0; calculateBaseScale(); }
        window.addEventListener('resize', calculateBaseScale);

        // Start
        initApp();

    </script>
</body>
</html>
